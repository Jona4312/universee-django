{% extends "base.html" %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %}Subir apunte Â· UniversoE{% endblock %}

{% block content %}

<section class="hero hero--intro" style="--hero:url('{% static "img/UniversoE.png" %}'); margin-top:14px; min-height: 320px;">
  <div class="hero-inner">
    <span class="hero-eyebrow">Subir recurso Â· Simple</span>
    <h1 class="hero-title">Sube tu apunte <span class="hero-primary-text">ðŸ“š</span></h1>
    <p class="hero-subtitle">Completa los datos bÃ¡sicos y comparte tu material con la comunidad.</p>
  </div>
</section>

<div class="container my-4">
    <div class="card shadow-sm" style="max-width: 980px; margin: 18px auto;">
        <div class="card-body p-4">
            <form id="form-subir" method="post" enctype="multipart/form-data" novalidate>
                {% csrf_token %}

                {% if form.non_field_errors %}
                    <div class="alert alert-danger">{{ form.non_field_errors }}</div>
                {% endif %}

                <h3 class="subsec-title border-bottom pb-2 mb-3">ðŸ“Œ Contexto</h3>
                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="facultad" class="form-label fw-bold">Facultad</label>
                        <select id="facultad" name="facultad" class="form-select" required>
                            <option value="">---------</option>
                            {% for f in facultades_list %}
                                <option value="{{ f }}">{{ f }}</option>
                            {% endfor %}
                        </select>
                        <div class="form-text">Elige primero la facultad.</div>
                    </div>
                    <div class="col-md-6">
                        <label for="carrera" class="form-label fw-bold">Carrera</label>
                        <select id="carrera" name="carrera" class="form-select" disabled required>
                            <option value="">---------</option>
                        </select>
                        <div class="form-text">Elige la carrera para clasificar tu apunte.</div>
                    </div>
                    <div class="col-12">
                        <label for="ramo" class="form-label fw-bold">Ramo</label>
                        <input type="text" id="ramo" name="ramo" class="form-control" placeholder="Ej: Estructuras de Datos" required>
                        <div class="form-text">Nombre del ramo/asignatura (texto libre).</div>
                    </div>
                </div>

                <h3 class="subsec-title border-bottom pb-2 mt-4 mb-3">ðŸ§¾ Detalles</h3>
                {{ form.titulo|as_crispy_field }}
                {{ form.descripcion|as_crispy_field }}

                <h3 class="subsec-title border-bottom pb-2 mt-4 mb-3">ðŸ“¦ Archivos & Meta</h3>
                {{ form.archivo|as_crispy_field }}
                <div class="row g-3">
                    <div class="col-md-6">{{ form.tipo|as_crispy_field }}</div>
                    <div class="col-md-6">{{ form.formato|as_crispy_field }}</div>
                </div>
                <div class="row g-3">
                    <div class="col-md-6">{{ form.anio|as_crispy_field }}</div>
                    <div class="col-md-6">{{ form.semestre|as_crispy_field }}</div>
                </div>

                <div class="d-flex justify-content-end mt-4">
                    <button id="btn-submit" class="btn btn-primary btn-lg" type="submit">Subir Apunte</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const facSelect = document.getElementById('facultad');
  const carSelect = document.getElementById('carrera');
  const carUrl = "{% url 'get_carreras_ajax' %}"; // Obtenemos la URL de nuestra "mini-API"

  facSelect.addEventListener('change', function() {
    const selectedFaculty = this.value;

    // Limpiamos y deshabilitamos el selector de carrera
    carSelect.innerHTML = '<option value="">---------</option>';
    carSelect.disabled = true;

    // Si se seleccionÃ³ una facultad vÃ¡lida...
    if (selectedFaculty) {
      // ...hacemos una llamada a nuestra URL, pasÃ¡ndole la facultad seleccionada
      fetch(`${carUrl}?facultad=${encodeURIComponent(selectedFaculty)}`)
        .then(response => response.json())
        .then(data => {
          // Cuando el servidor responde, rellenamos el selector de carrera
          if (data.carreras && data.carreras.length > 0) {
            data.carreras.forEach(carrera => {
              const option = new Option(carrera, carrera);
              carSelect.add(option);
            });
            // Habilitamos el selector de carrera
            carSelect.disabled = false;
          }
        })
        .catch(error => console.error('Error al cargar las carreras:', error));
    }
  });

  // UX: bloquear botÃ³n durante envÃ­o (este cÃ³digo se mantiene igual)
  const form = document.getElementById('form-subir');
  const btn = document.getElementById('btn-submit');
  if(form && btn) {
    form.addEventListener('submit', () => {
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Subiendoâ€¦';
    });
  }
});
</script>
{% endblock %}