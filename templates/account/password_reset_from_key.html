{% extends "base.html" %}
{% block title %}Nueva contraseña · UniversoE{% endblock %}

{% block content %}
<section class="auth-wrap" style="min-height:calc(100vh - 120px);display:flex;align-items:center;justify-content:center;padding:40px;background:linear-gradient(180deg,#3b82f6,#1e3a8a);">
  <div class="auth-card" style="width:100%;max-width:380px;background:#fff;border-radius:16px;box-shadow:0 15px 35px rgba(0,0,0,.15);padding:28px 24px;text-align:center;">
    <h1 style="font-size:24px;font-weight:900;color:#0f172a;margin-bottom:12px;">Nueva contraseña</h1>

    {% if token_fail %}
      <p style="color:#991b1b;background:#fef2f2;border:1px solid #fecaca;border-radius:10px;padding:12px;">
        El enlace no es válido o ya fue usado. Solicita uno nuevo.
      </p>
      <a href="{% url 'account_reset_password' %}" style="display:inline-block;margin-top:14px;color:#4f46e5;font-weight:700;">Volver a solicitar</a>
    {% else %}
      <form method="post" action="{{ action_url }}" style="display:grid;gap:12px;text-align:left;">
        {% csrf_token %}

        <label for="id_password1" style="font-weight:700;font-size:13px;color:#64748b;">Nueva contraseña</label>
        <div style="position:relative;">
          <input type="password" name="password1" id="id_password1" required placeholder="••••••••"
                 style="width:100%;height:42px;border:1px solid #e5e7eb;border-radius:10px;padding:8px 44px 8px 12px;font-size:15px;">
          <button type="button" class="eye" data-target="id_password1" aria-label="Mostrar" style="position:absolute;right:8px;top:50%;transform:translateY(-50%);border:0;background:transparent;cursor:pointer;font-size:16px;">👁️</button>
        </div>

        <label for="id_password2" style="font-weight:700;font-size:13px;color:#64748b;">Confirmar contraseña</label>
        <div style="position:relative;">
          <input type="password" name="password2" id="id_password2" required placeholder="••••••••"
                 style="width:100%;height:42px;border:1px solid #e5e7eb;border-radius:10px;padding:8px 44px 8px 12px;font-size:15px;">
          <button type="button" class="eye" data-target="id_password2" aria-label="Mostrar" style="position:absolute;right:8px;top:50%;transform:translateY(-50%);border:0;background:transparent;cursor:pointer;font-size:16px;">👁️</button>
        </div>

        <!-- Medidor de fuerza -->
        <div id="pwd-meter" style="margin-top:6px;">
          <div class="pwd-bar" style="height:8px;background:#e5e7eb;border-radius:999px;overflow:hidden;box-shadow:inset 0 1px 2px rgba(0,0,0,.06);">
            <span style="display:block;height:100%;width:0;background:linear-gradient(90deg,#ef4444,#f59e0b,#10b981);transition:width .25s ease;"></span>
          </div>
          <ul class="pwd-rules" style="list-style:none;padding:8px 0 0;margin:0;display:grid;gap:6px;">
            <li data-rule="len"     style="position:relative;padding-left:22px;font-size:13px;color:#6b7280;">Mínimo 8 caracteres</li>
            <li data-rule="mix"     style="position:relative;padding-left:22px;font-size:13px;color:#6b7280;">Incluye letras y números</li>
            <li data-rule="numeric" style="position:relative;padding-left:22px;font-size:13px;color:#6b7280;">No es solo numérica</li>
            <li data-rule="match"   style="position:relative;padding-left:22px;font-size:13px;color:#6b7280;">Coincide con la confirmación</li>
          </ul>
        </div>

        <button id="btn-save" type="submit" class="btn btn-primary" style="
          height:44px;border:none;border-radius:10px;font-weight:800;color:#fff;
          background:linear-gradient(90deg,#6366f1,#06b6d4);box-shadow:0 6px 14px rgba(99,102,241,.28);">Guardar</button>
      </form>
    {% endif %}
  </div>
</section>

<script>
  // Mostrar/ocultar contraseña
  document.querySelectorAll('.eye').forEach(btn => {
    btn.addEventListener('click', () => {
      const input = document.getElementById(btn.dataset.target);
      const isPwd = input.type === 'password';
      input.type = isPwd ? 'text' : 'password';
      btn.textContent = isPwd ? '🙈' : '👁️';
    });
  });

  // Medidor (mismo que en signup)
  (function () {
    const p1 = document.getElementById('id_password1');
    const p2 = document.getElementById('id_password2');
    const meter = document.getElementById('pwd-meter');
    if (!p1 || !p2 || !meter) return;
    const bar = meter.querySelector('.pwd-bar span');
    const rulesEls = {
      len: meter.querySelector('[data-rule="len"]'),
      mix: meter.querySelector('[data-rule="mix"]'),
      numeric: meter.querySelector('[data-rule="numeric"]'),
      match: meter.querySelector('[data-rule="match"]')
    };
    function setBullet(el, ok){
      if (!el.querySelector('.b')) el.insertAdjacentHTML('afterbegin','<span class="b" aria-hidden="true" style="position:absolute;left:0;top:0;font-size:14px;opacity:.9;">⚪</span>');
      el.querySelector('.b').textContent = ok ? '✅' : '⚪';
      el.style.color = ok ? '#065f46' : '#6b7280';
      el.style.fontWeight = ok ? '700' : '400';
    }
    const rules = {
      len: v => v.length >= 8,
      mix: v => /[A-Za-z]/.test(v) && /\d/.test(v),
      numeric: v => !/^\d+$/.test(v),
      match: v => v.length > 0 && v === p2.value
    };
    function score(v){ return (rules.len(v) + rules.mix(v) + rules.numeric(v) + rules.match(v)); }
    function paint(){
      const v = p1.value, s = score(v);
      bar.style.width = (Math.max(0,Math.min(4,s))*25)+'%';
      setBullet(rulesEls.len, rules.len(v));
      setBullet(rulesEls.mix, rules.mix(v));
      setBullet(rulesEls.numeric, rules.numeric(v));
      setBullet(rulesEls.match, rules.match(v));
      const can = s >= 3 && rules.match(v);
      const btn = document.getElementById('btn-save');
      btn.disabled = !can; btn.style.opacity = can ? '1' : '.6'; btn.style.cursor = can ? 'pointer':'not-allowed';
    }
    p1.addEventListener('input', paint); p2.addEventListener('input', paint); paint();
  })();
</script>
{% endblock %}
