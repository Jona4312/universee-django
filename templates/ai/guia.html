{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container mt-4">
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <h2 class="card-title">Guía inteligente</h2>
            <p class="card-text text-muted">Escribe un tema y te generamos una guía con teoría y ejercicios.</p>

            <form id="guide-form" method="POST" action="{% url 'guia_inteligente' %}">
                {% csrf_token %}
                <div class="row align-items-end g-2">
                    <div class="col-md-5">
                        <label for="topic-input" class="form-label">Tema</label>
                        <input type="text" id="topic-input" name="topic" class="form-control" placeholder="Ej: Álgebra lineal: matrices y determinantes" required>
                    </div>
                    <div class="col-md-3">
                        <label for="level-select" class="form-label">Nivel</label>
                        <select id="level-select" name="level" class="form-select">
                            <option>Universitario</option>
                            <option>Enseñanza Media</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="exercises-select" class="form-label">Ejercicios</label>
                        <select id="exercises-select" name="ejercicios" class="form-select">
                            <option>1</option>
                            <option>3</option>
                            <option selected>5</option>
                            <option>10</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <button type="submit" class="btn btn-primary w-100">Generar guía</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div id="loader" class="loader-container" style="display: none;">
        <img src="{% static 'img/rocket.png' %}" alt="Generando..." class="loader-rocket">
        <p class="loader-text">Generando tu guía...</p>
    </div>

    <div id="result-container">
        </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('guide-form');
    const loader = document.getElementById('loader');
    const resultContainer = document.getElementById('result-container');

    // --- Lógica para generar la guía (se mantiene igual) ---
    form.addEventListener('submit', function(event) {
        event.preventDefault();
        loader.style.display = 'flex';
        resultContainer.innerHTML = '';

        const formData = new FormData(form);

        fetch(form.action, {
            method: 'POST',
            body: formData,
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(response => {
            if (!response.ok) {
                return response.text().then(text => { throw new Error(text || 'Error del servidor') });
            }
            return response.text();
        })
        .then(html => {
            loader.style.display = 'none';
            resultContainer.innerHTML = html;
        })
        .catch(error => {
            loader.style.display = 'none';
            resultContainer.innerHTML = `<div class="alert alert-danger">Hubo un error: ${error.message}</div>`;
            console.error('Error:', error);
        });
    });

    // --- NUEVA LÓGICA: Manejar el clic del botón de descarga ---
    // Se escucha por clics en todo el contenedor de resultados.
    resultContainer.addEventListener('click', function(event) {
        // Verificamos si el elemento clickeado es nuestro botón de descarga
        if (event.target && event.target.id === 'download-pdf-btn') {
            event.preventDefault(); // Evita que el enlace navegue a "#"
            
            // 1. Obtenemos el texto de la guía desde el textarea
            const guideContent = document.getElementById('guide-content-textarea').value;
            
            // 2. Codificamos el texto para que pueda viajar seguro en una URL
            const encodedContent = encodeURIComponent(guideContent);
            
            // 3. Construimos la URL final de descarga
            const downloadUrl = `${event.target.href}?guide_content=${encodedContent}`;
            
            // 4. Abrimos la URL en una nueva pestaña para iniciar la descarga
            window.open(downloadUrl, '_blank');
        }
    });
});
</script>
{% endblock %}